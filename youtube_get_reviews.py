# thx to ChatGPT for the drudgery

# note: each search request for list of videos metadata that can contain at most 50 items incurs 100 units of quota, there is default daily limit of 10000 so for a massive channel with over 5000 videos you won't fit for a single search within the daily quota so do not spam usage of this script or you'll quickly run out

import csv
import logging

from googleapiclient.discovery import build
from os import getenv

log = logging.Logger('default')
log.setLevel(logging.WARN)

api_key = getenv('YOUTUBE_APIKEY')
channel_id = getenv('CHANNEL_ID')

youtube = build('youtube', 'v3', developerKey=api_key)



request = youtube.search().list( part='snippet', channelId=channel_id, maxResults=50 )
response = request.execute()

# cap here set at processing 500 = 10 * 50 videos, which consumes 1000 API quota usage
max_requests = 10 
request_number = 0 
response_items = []
while (response is not None and request_number<=max_requests): 
    request_number += 1
    response_items.append(response['items'])
    response = request.execute()

response_items = [{'kind': 'youtube#searchResult', 'etag': 'P1RxAPg5zaA81EpBBlUcVMdYU3A', 'id': {'kind': 'youtube#playlist', 'playlistId': 'PL6qJ3rmg3vKKgAziCzHS-53WKPXElmZah'}, 'snippet': {'publishedAt': '2013-10-11T10:03:51Z', 'channelId': 'UCO0ovgv7VG0c4Xjmpn7cXbQ', 'title': 'Other', 'description': '', 'thumbnails': {'default': {'url': 'https://i.ytimg.com/vi/74i2ILf70mk/default.jpg', 'width': 120, 'height': 90}, 'medium': {'url': 'https://i.ytimg.com/vi/74i2ILf70mk/mqdefault.jpg', 'width': 320, 'height': 180}, 'high': {'url': 'https://i.ytimg.com/vi/74i2ILf70mk/hqdefault.jpg', 'width': 480, 'height': 360}}, 'channelTitle': 'Ondrej Marek', 'liveBroadcastContent': 'none', 'publishTime': '2013-10-11T10:03:51Z'}}, {'kind': 'youtube#searchResult', 'etag': 'X_2F_znIwpH1e2qtDb6hAGV1LGA', 'id': {'kind': 'youtube#playlist', 'playlistId': 'PL6qJ3rmg3vKL80MZopGVXRM9dzyv0ylwg'}, 'snippet': {'publishedAt': '2020-06-15T16:59:19Z', 'channelId': 'UCO0ovgv7VG0c4Xjmpn7cXbQ', 'title': 'ffxiv', 'description': '', 'thumbnails': {'default': {'url': 'https://i.ytimg.com/vi/FwQf6H7ESo4/default.jpg', 'width': 120, 'height': 90}, 'medium': {'url': 'https://i.ytimg.com/vi/FwQf6H7ESo4/mqdefault.jpg', 'width': 320, 'height': 180}, 'high': {'url': 'https://i.ytimg.com/vi/FwQf6H7ESo4/hqdefault.jpg', 'width': 480, 'height': 360}}, 'channelTitle': 'Ondrej Marek', 'liveBroadcastContent': 'none', 'publishTime': '2020-06-15T16:59:19Z'}}, {'kind': 'youtube#searchResult', 'etag': 'on9uYrJNJFv7u9IiYOomWq3H-iY', 'id': {'kind': 'youtube#playlist', 'playlistId': 'PL6qJ3rmg3vKLZT4n2dxFmhqww01oScSBb'}, 'snippet': {'publishedAt': '2015-11-27T13:19:30Z', 'channelId': 'UCO0ovgv7VG0c4Xjmpn7cXbQ', 'title': 'film tips', 'description': '', 'thumbnails': {'default': {'url': 'https://i.ytimg.com/vi/6e4uKuxCo4M/default.jpg', 'width': 120, 'height': 90}, 'medium': {'url': 'https://i.ytimg.com/vi/6e4uKuxCo4M/mqdefault.jpg', 'width': 320, 'height': 180}, 'high': {'url': 'https://i.ytimg.com/vi/6e4uKuxCo4M/hqdefault.jpg', 'width': 480, 'height': 360}}, 'channelTitle': 'Ondrej Marek', 'liveBroadcastContent': 'none', 'publishTime': '2015-11-27T13:19:30Z'}}, {'kind': 'youtube#searchResult', 'etag': 'DD0-JNJTrw1e70QYSynJYX0UPaQ', 'id': {'kind': 'youtube#playlist', 'playlistId': 'PL6qJ3rmg3vKJIAAEvt2XmKd3q6RKlFalN'}, 'snippet': {'publishedAt': '2013-10-11T10:12:02Z', 'channelId': 'UCO0ovgv7VG0c4Xjmpn7cXbQ', 'title': 'Music / relax', 'description': '', 'thumbnails': {'default': {'url': 'https://i.ytimg.com/vi/qewzjSE2tbM/default.jpg', 'width': 120, 'height': 90}, 'medium': {'url': 'https://i.ytimg.com/vi/qewzjSE2tbM/mqdefault.jpg', 'width': 320, 'height': 180}, 'high': {'url': 'https://i.ytimg.com/vi/qewzjSE2tbM/hqdefault.jpg', 'width': 480, 'height': 360}}, 'channelTitle': 'Ondrej Marek', 'liveBroadcastContent': 'none', 'publishTime': '2013-10-11T10:12:02Z'}}, {'kind': 'youtube#searchResult', 'etag': '56dS_OArNlgzNQOgE7TQzZkWyNk', 'id': {'kind': 'youtube#playlist', 'playlistId': 'PL6qJ3rmg3vKKi8LshVgMOPGLrwk3pQyYD'}, 'snippet': {'publishedAt': '2018-05-22T16:12:48Z', 'channelId': 'UCO0ovgv7VG0c4Xjmpn7cXbQ', 'title': 'GDC', 'description': '', 'thumbnails': {'default': {'url': 'https://i.ytimg.com/vi/KLjTU0yKS00/default.jpg', 'width': 120, 'height': 90}, 'medium': {'url': 'https://i.ytimg.com/vi/KLjTU0yKS00/mqdefault.jpg', 'width': 320, 'height': 180}, 'high': {'url': 'https://i.ytimg.com/vi/KLjTU0yKS00/hqdefault.jpg', 'width': 480, 'height': 360}}, 'channelTitle': 'Ondrej Marek', 'liveBroadcastContent': 'none', 'publishTime': '2018-05-22T16:12:48Z'}}, {'kind': 'youtube#searchResult', 'etag': '1sGZSmOWr-5DOZSMp_RXlZlmcsQ', 'id': {'kind': 'youtube#playlist', 'playlistId': 'PL6qJ3rmg3vKIfk9V6KlHNUGIuLyf2OySc'}, 'snippet': {'publishedAt': '2013-10-11T09:53:26Z', 'channelId': 'UCO0ovgv7VG0c4Xjmpn7cXbQ', 'title': 'Music / badass', 'description': '', 'thumbnails': {'default': {'url': 'https://i.ytimg.com/vi/ZhJUtVoE5KU/default.jpg', 'width': 120, 'height': 90}, 'medium': {'url': 'https://i.ytimg.com/vi/ZhJUtVoE5KU/mqdefault.jpg', 'width': 320, 'height': 180}, 'high': {'url': 'https://i.ytimg.com/vi/ZhJUtVoE5KU/hqdefault.jpg', 'width': 480, 'height': 360}}, 'channelTitle': 'Ondrej Marek', 'liveBroadcastContent': 'none', 'publishTime': '2013-10-11T09:53:26Z'}}, {'kind': 'youtube#searchResult', 'etag': 'rwITqlPI0jJzzEXnnFtFC9fYXdc', 'id': {'kind': 'youtube#playlist', 'playlistId': 'PL6qJ3rmg3vKKl7yRReTTEshzTHFcTHPLv'}, 'snippet': {'publishedAt': '2013-10-11T10:03:16Z', 'channelId': 'UCO0ovgv7VG0c4Xjmpn7cXbQ', 'title': 'Fun', 'description': '', 'thumbnails': {'default': {'url': 'https://i.ytimg.com/vi/urNyg1ftMIU/default.jpg', 'width': 120, 'height': 90}, 'medium': {'url': 'https://i.ytimg.com/vi/urNyg1ftMIU/mqdefault.jpg', 'width': 320, 'height': 180}, 'high': {'url': 'https://i.ytimg.com/vi/urNyg1ftMIU/hqdefault.jpg', 'width': 480, 'height': 360}}, 'channelTitle': 'Ondrej Marek', 'liveBroadcastContent': 'none', 'publishTime': '2013-10-11T10:03:16Z'}}, {'kind': 'youtube#searchResult', 'etag': 'XSiN5pz4srQKOfKlljUNhxPpRKg', 'id': {'kind': 'youtube#playlist', 'playlistId': 'PL6qJ3rmg3vKJzoDnG5lof2jChbNzL4wRu'}, 'snippet': {'publishedAt': '2019-08-17T22:07:34Z', 'channelId': 'UCO0ovgv7VG0c4Xjmpn7cXbQ', 'title': 'bdo', 'description': '', 'thumbnails': {'default': {'url': 'https://i.ytimg.com/vi/a8wH92MQl1Y/default.jpg', 'width': 120, 'height': 90}, 'medium': {'url': 'https://i.ytimg.com/vi/a8wH92MQl1Y/mqdefault.jpg', 'width': 320, 'height': 180}, 'high': {'url': 'https://i.ytimg.com/vi/a8wH92MQl1Y/hqdefault.jpg', 'width': 480, 'height': 360}}, 'channelTitle': 'Ondrej Marek', 'liveBroadcastContent': 'none', 'publishTime': '2019-08-17T22:07:34Z'}}, {'kind': 'youtube#searchResult', 'etag': 'x07belnGaIf1atHnAuJKnqh4oHI', 'id': {'kind': 'youtube#playlist', 'playlistId': 'PL6qJ3rmg3vKJioMk2p3Ksibo_e2553J7m'}, 'snippet': {'publishedAt': '2020-04-02T15:25:51Z', 'channelId': 'UCO0ovgv7VG0c4Xjmpn7cXbQ', 'title': 'games', 'description': '', 'thumbnails': {'default': {'url': 'https://i.ytimg.com/vi/Wt80Wu4gUHg/default.jpg', 'width': 120, 'height': 90}, 'medium': {'url': 'https://i.ytimg.com/vi/Wt80Wu4gUHg/mqdefault.jpg', 'width': 320, 'height': 180}, 'high': {'url': 'https://i.ytimg.com/vi/Wt80Wu4gUHg/hqdefault.jpg', 'width': 480, 'height': 360}}, 'channelTitle': 'Ondrej Marek', 'liveBroadcastContent': 'none', 'publishTime': '2020-04-02T15:25:51Z'}}, {'kind': 'youtube#searchResult', 'etag': 'e_i2d5NRZwW-Vhsm42M4BK22Btg', 'id': {'kind': 'youtube#playlist', 'playlistId': 'PL6qJ3rmg3vKIAaKSJ8ZExnbttzyLzKkE9'}, 'snippet': {'publishedAt': '2013-10-11T10:01:59Z', 'channelId': 'UCO0ovgv7VG0c4Xjmpn7cXbQ', 'title': 'Music / classic', 'description': '', 'thumbnails': {'default': {'url': 'https://i.ytimg.com/vi/h0ffIJ7ZO4U/default.jpg', 'width': 120, 'height': 90}, 'medium': {'url': 'https://i.ytimg.com/vi/h0ffIJ7ZO4U/mqdefault.jpg', 'width': 320, 'height': 180}, 'high': {'url': 'https://i.ytimg.com/vi/h0ffIJ7ZO4U/hqdefault.jpg', 'width': 480, 'height': 360}}, 'channelTitle': 'Ondrej Marek', 'liveBroadcastContent': 'none', 'publishTime': '2013-10-11T10:01:59Z'}}, {'kind': 'youtube#searchResult', 'etag': 'L-VbfoJxmgD7D2ibvWCsPRuAmGk', 'id': {'kind': 'youtube#playlist', 'playlistId': 'PL6qJ3rmg3vKKrGBQMTt6oO7BoW5wvtd6X'}, 'snippet': {'publishedAt': '2019-02-24T16:35:35Z', 'channelId': 'UCO0ovgv7VG0c4Xjmpn7cXbQ', 'title': 'elite dangerous', 'description': '', 'thumbnails': {'default': {'url': 'https://i.ytimg.com/vi/6WeFGT6kxok/default.jpg', 'width': 120, 'height': 90}, 'medium': {'url': 'https://i.ytimg.com/vi/6WeFGT6kxok/mqdefault.jpg', 'width': 320, 'height': 180}, 'high': {'url': 'https://i.ytimg.com/vi/6WeFGT6kxok/hqdefault.jpg', 'width': 480, 'height': 360}}, 'channelTitle': 'Ondrej Marek', 'liveBroadcastContent': 'none', 'publishTime': '2019-02-24T16:35:35Z'}}, {'kind': 'youtube#searchResult', 'etag': 'JoN2lRLRbozR-AG3alWJ8g7MOLE', 'id': {'kind': 'youtube#playlist', 'playlistId': 'PL6qJ3rmg3vKL7UmiKLkNM3In-JgoOOOCV'}, 'snippet': {'publishedAt': '2018-05-22T16:17:15Z', 'channelId': 'UCO0ovgv7VG0c4Xjmpn7cXbQ', 'title': 'Game dev', 'description': '', 'thumbnails': {'default': {'url': 'https://i.ytimg.com/vi/Zc9VBoLekRU/default.jpg', 'width': 120, 'height': 90}, 'medium': {'url': 'https://i.ytimg.com/vi/Zc9VBoLekRU/mqdefault.jpg', 'width': 320, 'height': 180}, 'high': {'url': 'https://i.ytimg.com/vi/Zc9VBoLekRU/hqdefault.jpg', 'width': 480, 'height': 360}}, 'channelTitle': 'Ondrej Marek', 'liveBroadcastContent': 'none', 'publishTime': '2018-05-22T16:17:15Z'}}, {'kind': 'youtube#searchResult', 'etag': '4pPrKdSDDL2yBguKmbq0fTfVSWU', 'id': {'kind': 'youtube#playlist', 'playlistId': 'PL6qJ3rmg3vKKK6GWEArvsqYWwuxXPXYfo'}, 'snippet': {'publishedAt': '2019-04-07T16:35:43Z', 'channelId': 'UCO0ovgv7VG0c4Xjmpn7cXbQ', 'title': 'borderlands', 'description': '', 'thumbnails': {'default': {'url': 'https://i.ytimg.com/vi/BRvFurQqoqQ/default.jpg', 'width': 120, 'height': 90}, 'medium': {'url': 'https://i.ytimg.com/vi/BRvFurQqoqQ/mqdefault.jpg', 'width': 320, 'height': 180}, 'high': {'url': 'https://i.ytimg.com/vi/BRvFurQqoqQ/hqdefault.jpg', 'width': 480, 'height': 360}}, 'channelTitle': 'Ondrej Marek', 'liveBroadcastContent': 'none', 'publishTime': '2019-04-07T16:35:43Z'}}, {'kind': 'youtube#searchResult', 'etag': 'TJcxkCFpS1qQDq10wdpLtXjC1rA', 'id': {'kind': 'youtube#playlist', 'playlistId': 'PL6qJ3rmg3vKJHIc93Pu0saaEJcxpIg8vE'}, 'snippet': {'publishedAt': '2019-03-08T12:11:36Z', 'channelId': 'UCO0ovgv7VG0c4Xjmpn7cXbQ', 'title': 'poe', 'description': '', 'thumbnails': {'default': {'url': 'https://i.ytimg.com/vi/HvpVhsn61D8/default.jpg', 'width': 120, 'height': 90}, 'medium': {'url': 'https://i.ytimg.com/vi/HvpVhsn61D8/mqdefault.jpg', 'width': 320, 'height': 180}, 'high': {'url': 'https://i.ytimg.com/vi/HvpVhsn61D8/hqdefault.jpg', 'width': 480, 'height': 360}}, 'channelTitle': 'Ondrej Marek', 'liveBroadcastContent': 'none', 'publishTime': '2019-03-08T12:11:36Z'}}, {'kind': 'youtube#searchResult', 'etag': 'ngLZdTzlk-AfrZnlsjpbiQRWoFI', 'id': {'kind': 'youtube#playlist', 'playlistId': 'PL6qJ3rmg3vKLSaOh9WaABFxeHHzypXXN1'}, 'snippet': {'publishedAt': '2018-09-30T23:43:11Z', 'channelId': 'UCO0ovgv7VG0c4Xjmpn7cXbQ', 'title': 'warframe', 'description': '', 'thumbnails': {'default': {'url': 'https://i.ytimg.com/vi/1PDaWzi2o9U/default.jpg', 'width': 120, 'height': 90}, 'medium': {'url': 'https://i.ytimg.com/vi/1PDaWzi2o9U/mqdefault.jpg', 'width': 320, 'height': 180}, 'high': {'url': 'https://i.ytimg.com/vi/1PDaWzi2o9U/hqdefault.jpg', 'width': 480, 'height': 360}}, 'channelTitle': 'Ondrej Marek', 'liveBroadcastContent': 'none', 'publishTime': '2018-09-30T23:43:11Z'}}]


csv_file = '_data/data.csv'
log.info(f'writing to csv file: {csv_file}')

rows = []
for video in response_items:
    if video['id']['kind'] != 'youtube#video': continue
    title = video['snippet']['title'].replace(',',';')
    url = f"https://www.youtube.com/watch?v={video['id']['videoId']}"
    description = video['snippet']['description'].replace(',',';')
    id = video['id']['videoId']
    published_at = video['snippet']['publishedAt']
    default_thumbnail_url = video['snippet']['thumbnails']['default']['url']
    rows += [(id, title, description, published_at, default_thumbnail_url )]

with open(csv_file, 'w', newline='') as file_handle:
    output = csv.writer(file_handle)
    # default thumbnail is 120x90
    output.writerow(('id','title','description','published_at', 'd_thumbnail'))

    for row in rows:
        log.info(f'Writing row: {row} ..')
        output.writerow( row )
    

